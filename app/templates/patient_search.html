{# templates/patient_search.html #}
{% extends "layout/base.html" %}

{% block title %}Patient Search{% endblock %}

{% block content %}
<div class="container my-4">
  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><a class="nav-link active" href="#">Patient Search</a></li>
    <li class="nav-item"><a class="nav-link" href="#">Patient Registration</a></li>
    <li class="nav-item"><a class="nav-link" href="#">Appointment Scheduler</a></li>
    <li class="nav-item"><a class="nav-link" href="#">Masters Management</a></li>
  </ul>

  <!-- Patient Search Form -->
  <div class="card p-4">
    <h5>T√¨m ki·∫øm b·ªánh nh√¢n</h5>
    <div class="row mb-3">
      <div class="col-10">
        <input id="searchInput" type="text" class="form-control" placeholder="Search patients...">
      </div>
      <div class="col-2">
        <button id="searchBtn" class="btn btn-dark w-100">T√¨m ki·∫øm chung</button>
      </div>
    </div>

    <!-- Search Filters -->
    <h6>T√¨m ki·∫øm</h6>
    <div class="row mb-3">
      <div class="col-md-3">
        <input type="checkbox">ID
        <input type="text" class="form-control mt-1" placeholder="Enter Patient ID">
      </div>
      <div class="col-md-3">
        <input type="checkbox"> T√™n
        <input type="text" class="form-control mt-1" placeholder="First/Last/Full Name">
      </div>
      <div class="col-md-3">
        <input type="checkbox"> Ng√†y sinh
        <input type="date" class="form-control mt-1">
      </div>
      <div class="col-md-3">
        <input type="checkbox" id="phoneChk"> S·ªë ƒëi·ªán tho·∫°i
        <input type="text" id="phoneInput" class="form-control mt-1" placeholder="Enter phone number">
      </div>
    </div>

    <div class="mb-3">
      <label class="me-2"><input type="checkbox" id="activeChk" checked> Ho·∫°t ƒë·ªông</label>
      <label class="me-2"><input type="checkbox" id="inactiveChk"> KH√¥ng ho·∫°t ƒë·ªông</label>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        Registration Date:
        <input type="date" class="form-control mt-1">
      </div>
      <div class="col-md-4 mt-4">
        to <input type="date" class="form-control d-inline-block w-auto ms-2">
      </div>
    </div>

    <button id="applyFilterBtn" class="btn btn-dark">Apply Filters</button>
  </div>

  <!-- Search Results -->
  <div class="card p-4 mt-4">
    <h5>T√¨m ki·∫øm b·ªánh nh√¢n</h5>
    <table class="table table-bordered mt-3">
      <thead class="table-light">
        <tr>
          <th>T√™n b·ªánh nh√¢n</th>
          <th>Tu·ªïi</th>
          <th>Gi·ªõi t√≠nh</th>
          <th>S·ªë ƒëi·ªán tho·∫°i</th>
          <th>L·∫ßn g·∫ßn nh·∫•t kh√°m b·ªánh</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="patientTableBody">
        <tr><td colspan="6" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>
      </tbody>
    </table>

    <!-- Pagination simple -->
    <nav>
      <ul class="pagination justify-content-center" id="pagination">
      </ul>
    </nav>
  </div>
</div>

<script>
  (function(){
    let currentPage = 1;
    const perPage = 10;

    async function loadPatients(page=1){
      const q = document.getElementById("searchInput").value.trim();
      const active = document.getElementById("activeChk").checked ? "1" : "";
      const inactive = document.getElementById("inactiveChk").checked ? "1" : "";
      const phoneChk = document.getElementById("phoneChk").checked;
      const phoneNumber = phoneChk ? document.getElementById("phoneInput").value.trim() : "";

      const tbody = document.getElementById("patientTableBody");
      tbody.innerHTML = `<tr><td colspan="6" class="text-center">Loading...</td></tr>`;

      try {
        // NOTE: your API currently returns an array (no total). We consume that.
        const res = await fetch(`/api/patients?q=${encodeURIComponent(q)}&phone=${encodeURIComponent(phoneNumber)}&active=${active}&inactive=${inactive}&page=${page}&per_page=${perPage}`);
        if(!res.ok) throw new Error("Network error");
        const data = await res.json(); // EXPECT: array of patients

        // If your API later changes to return {patients, total}, adapt here.
        const patients = Array.isArray(data) ? data : (data.patients || []);
        tbody.innerHTML = "";

        if (patients.length === 0) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center">No patients found</td></tr>`;
        } else {
          patients.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.name || ''}</td>
              <td>${p.age ?? ''}</td>
              <td>${p.gender ?? ''}</td>
              <td>${p.contact ?? ''}</td>
              <td>${p.last_visit_date ?? ''}</td>
              <td>
                <a class="btn btn-outline-dark btn-sm" href="/patients/${p.id}">üëÅ Chi Ti·∫øt</a>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        // build simple prev/next pagination using returned length (we can't know total pages if backend doesn't send total)
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = `
          <li class="page-item ${page===1?'disabled':''}">
            <a class="page-link" href="#" onclick="changePage(${page-1});return false;">Trang</a>
          </li>
          <li class="page-item active"><span class="page-link">${page}</span></li>
          <li class="page-item ${patients.length < perPage ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${page+1});return false;">>></a>
          </li>
        `;

      } catch (err) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error loading patients: ${err.message}</td></tr>`;
        console.error(err);
      }
    }

    // expose changePage to inline onclick in pagination
    window.changePage = function(page){
      if(page < 1) return;
      currentPage = page;
      loadPatients(page);
    }

    document.addEventListener("DOMContentLoaded", function(){
      document.getElementById("searchBtn").addEventListener("click", ()=> loadPatients(1));
      document.getElementById("applyFilterBtn").addEventListener("click", ()=> loadPatients(1));
      loadPatients(1);
    });
  })();
</script>
{% endblock %}
