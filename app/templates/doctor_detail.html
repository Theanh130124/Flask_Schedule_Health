{% extends "layout/base.html" %} {% block title %}Chi tiết bác sĩ{% endblock %}
{% block content %}
<div class="container py-4">
  <a
    href="{{ request.referrer or url_for('home') }}"
    class="btn btn-primary mb-3"
  >
    &larr; Quay lại
  </a>

  <div class="row g-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        {% if d.user and d.user.avatar %}
        <img
          class="card-img-top object-fit-cover"
          style="height: 260px"
          src="{{ d.user.avatar }}"
          alt="Ảnh bác sĩ"
        />
        {% endif %}
        <div class="card-body">
          <h4 class="mb-1">
            Bác sĩ {{ (d.user.first_name ~ ' ' ~ d.user.last_name)|trim }}
          </h4>

          <div class="text-muted">
            <i class="bi bi-hospital me-1"></i>
            {{ d.hospital.name if d.hospital else "—" }}
          </div>

          <div class="mt-2">
            <span class="badge bg-info-subtle text-info">
              {{ d.specialty.name if d.specialty else "Chưa có chuyên khoa" }}
            </span>
          </div>

          <hr />

          <ul class="list-unstyled small mb-0">
            <li>
              <strong>Email:</strong> {{ d.user.email if d.user else "—" }}
            </li>
            <li>
              <strong>Điện thoại:</strong> {{ d.user.phone_number if d.user else
              "—" }}
            </li>
            <li>
              <strong>Ngày sinh:</strong> {{ d.user.date_of_birth or "—" }}
            </li>
            <li>
              <strong>Giới tính:</strong> {{ d.user.gender.value if d.user and
              d.user.gender else "—" }}
            </li>
            <li>
              <strong>Địa chỉ:</strong> {{ d.user.address if d.user else "—" }}
            </li>
            <li>
              <strong>Kinh nghiệm:</strong> {{ d.years_experience or "—" }} năm
            </li>
            <li>
              <strong>Phí khám:</strong>
              {% if d.consultation_fee is not none %} {{
              "{:,.0f}".format(d.consultation_fee) }} đ {% else %}—{% endif %}
            </li>
            <li>
              <strong>Đánh giá Trung bình:</strong> {{ avg_rating if avg_rating is not
              none else "Chưa có" }}
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Cột phải: chi tiết -->
    <div class="col-12 col-lg-8">
      <!-- Giới thiệu -->
      <div class="card shadow-sm mb-3">
        <div class="card-header fw-semibold">Giới thiệu</div>
        <div class="card-body">
          <p class="mb-0">{{ d.bio or "Chưa cập nhật." }}</p>
        </div>
      </div>

      <!-- Bệnh viện -->
      <div class="card shadow-sm mb-3">
        <div class="card-header fw-semibold">Bệnh viện</div>
        <div class="card-body">
          <div class="mb-1">
            <strong>Tên:</strong> {{ d.hospital.name if d.hospital else "—" }}
          </div>
          <div class="mb-1">
            <strong>Địa chỉ:</strong> {{ d.hospital.address if d.hospital else
            "—" }}
          </div>
          <div class="mb-1">
            <strong>Điện thoại:</strong> {{ d.hospital.phone_number if
            d.hospital and d.hospital.phone_number else "—" }}
          </div>
          <div class="mb-1">
            <strong>Bảo hiểm:</strong>
            {% if d.hospital and d.hospital.accepts_insurance %}
            <span class="badge bg-success">Có bảo hiểm</span>
            {% else %}
            <span class="badge bg-secondary">Không bảo hiểm</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Chuyên khoa & Trình độ -->
      <div class="card shadow-sm mb-3">
        <div class="card-header fw-semibold">Chuyên khoa & Trình độ</div>
        <div class="card-body">
          <div class="mb-1">
            <strong>Chuyên khoa:</strong> {{ d.specialty.name if d.specialty
            else "—" }}
          </div>
          {% if d.specialty and d.specialty.description %}
          <div class="small text-muted mb-2">{{ d.specialty.description }}</div>
          {% endif %}
          <div class="mb-1">
            <strong>Trình độ:</strong> {{ d.educational_level or "—" }}
          </div>
        </div>
      </div>

      <!-- Chứng chỉ -->
      {% set _licenses = licenses if licenses is defined else d.licenses %}
      <div class="card shadow-sm mb-3">
        <div class="card-header fw-semibold">Chứng chỉ hành nghề</div>
        <div class="card-body p-0">
          {% if _licenses and _licenses|length > 0 %}
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Số hiệu</th>
                <th>Nơi cấp</th>
                <th>Ngày cấp</th>
                <th>Hết hạn</th>
                <th>Phạm vi hành nghề</th>
              </tr>
            </thead>
            <tbody>
              {% for lic in _licenses %}
              <tr>
                <td>{{ lic.license_number or "—" }}</td>
                <td>{{ lic.issuing_authority or "—" }}</td>
                <td>
                  {{ lic.issue_date.strftime('%d/%m/%Y') if lic.issue_date else
                  "—" }}
                </td>
                <td>
                  {{ lic.expiry_date.strftime('%d/%m/%Y') if lic.expiry_date
                  else "—" }}
                </td>
                <td>{{ lic.scope_description or "—" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          <div class="p-3 text-muted">Chưa có dữ liệu chứng chỉ.</div>
          {% endif %}
        </div>
      </div>
      <div class="card shadow-sm mb-3">
    <div class="card-header fw-semibold">Lịch làm việc</div>
    <div class="card-body">
      {% if availabilities and availabilities|length > 0 %}
            <div class="row">
                {% set available_days = availabilities|selectattr("is_available")|list %}
                {% if available_days|length > 0 %}
                    {% for availability in available_days %}
                        <div class="col-md-6 mb-2">
                            <strong>{{ availability.day_of_week.value }}:</strong>
                            {{ availability.start_time.strftime('%H:%M') }} - {{ availability.end_time.strftime('%H:%M') }}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="col-12">
                        <p class="text-muted mb-0">Bác sĩ chưa thiết lập lịch làm việc.</p>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="text-muted">Chưa có thông tin lịch làm việc.</div>
        {% endif %}
          </div>
</div>

      <!-- Đánh giá -->
      {% set _reviews = reviews if reviews is defined else d.reviews %}
      <div class="card shadow-sm" id="write-review">
        <div class="card-header fw-semibold">Đánh giá</div>
        <div class="card-body">
        {% if current_user.is_authenticated and current_user.role.value == 'PATIENT' %}
        {% if eligible_appts and eligible_appts|length > 0 %}
        <form method="post" action="{{ url_for('review_create', doctor_id=d.doctor_id) }}" class="mb-2">
            <div class="mb-2">
                <label class="form-label">Chọn cuộc hẹn</label>
                <select name="appointment_id" class="form-control" required>
                    <option value="">Chọn một cuộc hẹn</option>
                    {% for appt in eligible_appts %}
                    <option value="{{ appt.appointment_id }}">
                        {{ appt.appointment_time.strftime('%d/%m/%Y %H:%M') }} - {{ appt.reason or 'Không có lý do' }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-2">
                <label class="form-label">Chấm điểm (1–5)</label>
                <input type="number" name="rating" class="form-control" min="1" max="5" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Bình luận</label>
                <textarea name="comment" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">Gửi đánh giá</button>
        </form>
        <div class="alert alert-warning py-2 px-3 small mb-3">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Lưu ý: Bạn chỉ được đánh giá <strong>một lần</strong> cho mỗi cuộc hẹn và <strong>không thể chỉnh sửa</strong> sau khi gửi.
        </div>
        {% else %}
        <div class="alert alert-info mb-3">
            Bạn chưa có lịch hẹn hoàn tất với bác sĩ này nên không được viết đánh giá.
        </div>
        {% endif %}
        {% endif %}
          {% if _reviews and _reviews|length > 0 %}
          <div class="mb-2">
            <strong>Trung bình:</strong> {{ avg_rating if avg_rating is not none
            else 'Chưa có' }}
            <span class="text-muted">({{ _reviews|length }} đánh giá)</span>
          </div>

          <ul class="list-group list-group-flush">
            {% for r in _reviews %}
            <li class="list-group-item">
              <div class="d-flex justify-content-between">
                <strong>Chất lượng khám {{ r.rating }} sao</strong>
                <span class="small text-muted">
                  {{ r.review_date.strftime('%d/%m/%Y %H:%M') if r.review_date
                  else "" }}
                </span>
              </div>
              <div>{{ r.comment or "" }}</div>

              <!-- Phản hồi -->
              {% if r.doctor_response %}
              <div class="mt-2 p-2 bg-light border rounded small">
                <strong>Bác sĩ phản hồi:</strong> {{ r.doctor_response }}
                <div class="text-muted">
                  {{ r.response_date.strftime('%d/%m/%Y %H:%M') if
                  r.response_date else "" }}
                </div>
              </div>
              {% elif current_user.is_authenticated and current_user.role.value
              == 'DOCTOR' and current_user.user_id == d.doctor_id %}
              <form
                method="post"
                action="{{ url_for('review_reply', review_id=r.review_id) }}"
                class="mt-2"
              >
                <textarea
                  name="response"
                  class="form-control form-control-sm mb-2"
                  placeholder="Trả lời bệnh nhân..."
                  required
                ></textarea>
                <button type="submit" class="btn btn-sm btn-outline-primary">
                  Gửi phản hồi
                </button>
              </form>
              <div class="alert alert-warning py-2 px-3 small mt-2 mb-0">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Lưu ý: Bạn chỉ được phản hồi
                <strong>một lần duy nhất</strong> và
                <strong>không thể chỉnh sửa</strong> sau khi gửi.
              </div>
              {% endif %}
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <div class="text-muted">Chưa có đánh giá.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <!-- /col-right -->
  </div>
  <!-- /row -->
</div>
<!-- /container -->
{% endblock %}
